name: Release KSU

permissions:
  contents: write
  actions: write

on:
  workflow_call: # This allows this workflow to be called from another workflow
   inputs:
     kernelsu_variant:
       required: true
       type: string
     kernelsu_commit:
       required: false
       type: string
     enable_susfs:
        required: false
        type: boolean
     susfs_commit:
       required: false
       type: string
     ksuver:                 
        required: true
        type: string     
       
  workflow_dispatch:
   inputs:
     kernelsu_variant:
       required: true
       type: string
     kernelsu_commit:
       required: false
       type: string
     enable_susfs:
        required: false
        type: boolean
     susfs_commit:
       required: false
       type: string
     ksuver:                 
        required: true
        type: string

jobs:

  release:
    runs-on: ubuntu-latest
    env:
      KSU_VER: ${{ inputs.ksuver }}
      GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
      RELEASE_NAME: "GKI Kernels With XKNSU & SUSFS v2.0.0"
      RELEASE_BODY:
      
    steps:
     
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get commit hashes and generate commit URLs
        if: ${{ inputs.enable_susfs }}
        run: |
          GITLAB_OWNER="simonpunk"
          GITLAB_REPO="susfs4ksu"
          # User-provided commit (may be empty)
          SUSFS_COMMIT="${{ inputs.susfs_commit }}"
          declare -A BRANCH_MAP=(
            ["gki_android15_6_6"]="gki-android15-6.6"
          )
          for var_name in "${!BRANCH_MAP[@]}"; do
            branch_name="${BRANCH_MAP[$var_name]}"
            if [ -n "$SUSFS_COMMIT" ]; then
              echo "Using user-provided SUSFS commit: $SUSFS_COMMIT"
              COMMIT_HASH="$SUSFS_COMMIT"
            else
              echo "No SUSFS commit provided ‚Äî fetching branch HEAD"
              COMMIT_HASH=$(git ls-remote "https://gitlab.com/$GITLAB_OWNER/$GITLAB_REPO.git" "refs/heads/$branch_name" | awk '{ print $1 }')
            fi
            COMMIT_URL="https://gitlab.com/$GITLAB_OWNER/$GITLAB_REPO/-/commit/$COMMIT_HASH"
            echo "$branch_name Commit: $COMMIT_HASH"
            echo "$branch_name Commit URL: $COMMIT_URL"
            echo "COMMIT_HASH_${var_name}=$COMMIT_HASH" >> "$GITHUB_ENV"
            echo "COMMIT_URL_${var_name}=$COMMIT_URL" >> "$GITHUB_ENV"
          done
            
      - name: Get KernelSU variant refs and links
        run: |
          KERNELSU_COMMIT="${{ inputs.kernelsu_commit }}"
          if [ -n "$KERNELSU_COMMIT" ]; then
            echo "Using user-provided KernelSU commit: $KERNELSU_COMMIT"
            WKSU_REF="$KERNELSU_COMMIT"
          else
            echo "No KernelSU commit provided ‚Äî fetching latest main branch commit"
            WKSU_REF=$(git ls-remote "https://github.com/tiann/KernelSU.git" refs/heads/main | awk '{print $1}')
          fi
          WKSU_URL="https://github.com/tiann/KernelSU/commit/$WKSU_REF"
          echo "WKSU_REF=$WKSU_REF" >> $GITHUB_ENV
          echo "WKSU_URL=$WKSU_URL" >> $GITHUB_ENV
          echo "KernelSU Reference: $WKSU_REF"
          echo "KernelSU URL: $WKSU_URL"
          
          # Get Baseband-guard latest commit from main branch
          BBG_REF=$(git ls-remote "https://github.com/vc-teahouse/Baseband-guard.git" refs/heads/main | awk '{print $1}')
          BBG_URL="https://github.com/vc-teahouse/Baseband-guard/commit/$BBG_REF"
          echo "BBG_REF=$BBG_REF" >> $GITHUB_ENV
          echo "BBG_URL=$BBG_URL" >> $GITHUB_ENV
      
      - name: Generate and Create New Tag
        env:
            GH_TOKEN: ${{ github.token }}
        run: |
            LATEST_TAG=$(gh api repos/${{ github.repository }}/tags --jq '.[0].name')
            if [ -z "$LATEST_TAG" ]; then
              LATEST_TAG="v1.5.12-r0"
            fi
            
            NEW_TAG=$(echo "$LATEST_TAG" | awk -F'-r' '{suffix=$2; if (!suffix) suffix=0; suffix++; printf "%s-r%d", $1, suffix}')
    
            echo "New tag: $NEW_TAG"
            echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_ENV

            git tag $NEW_TAG
            git push origin $NEW_TAG
            
     
      - name: Download Artifacts
        uses: actions/download-artifact@v5
        with:
          path: ./downloaded-artifacts
          pattern: 'XKNSU-*-AnyKernel3'

      - name: List downloaded artifacts
        run: |
          echo "Contents of downloaded-artifacts:"
          ls -R downloaded-artifacts || echo "Folder empty"
      
      - name: Extract selected artifacts cleanly
        run: |
          echo "üîç Selecting and extracting matching artifacts..."
          mkdir -p temp temp_extract
          # Step 1: Move only matching zips to temp/
          MATCH_ZIP_PATTERNS=("*XKNSU-*-AnyKernel3")
          for pattern in "${MATCH_ZIP_PATTERNS[@]}"; do
          find downloaded-artifacts -maxdepth 2 -type f -name "$pattern" -exec mv -f {} temp/ \;
          done
          echo "‚úÖ Selected zips moved to temp/:"
          ls -lh temp/ || echo "No matching zips found!"
          # Step 2: Extract zips from temp/ to temp_extract/
          for zipfile in temp/*.zip; do
          [ -e "$zipfile" ] || continue
          echo "üì¶ Extracting: $zipfile"
          unzip -q "$zipfile" -d temp_extract/
          done
          # Step 3: Move extracted files (not just zips) back to downloaded-artifacts/
          MATCH_FILE_PATTERNS=("*-XKNSU-*-AnyKernel3")
          for pattern in "${MATCH_FILE_PATTERNS[@]}"; do
          find temp_extract -type f -name "$pattern" -exec mv -f {} downloaded-artifacts/ \;
          done
          # Step 4: Clean up
          echo "üßπ Cleaning temporary folders..."
          rm -rf temp temp_extract
          echo "‚úÖ Final files in downloaded-artifacts/:"
          ls -lh downloaded-artifacts/ || echo "No extracted files found."
     
      - name: Set release body (With SUSFS)
        if: ${{ inputs.enable_susfs }}
        run: |
          cat << EOF > release_body.md
      
          **‚ú® XENNET KERNELSU**
          **üåÄ XKNSU v${{ env.KSUVER }}**
          **üõ°Ô∏è SUSFS ‡∂û v2.0.0**
          **üß¨ HymoFS Enabled**
          **üåê IPSet Support for Advanced Network Filtering**
          **üü¢ WireGuard Support**
          **üöÄ BBR v1 Support**
          **üîí BBG Protection to Prevent Unauthorized Writes to Certain Partitions**
        
          Commit Hashes (at the time of release):
          -> XENNET KERNELSU: [${{ env.WKSU_REF }}](${{ env.WKSU_URL }})

          -> Baseband-guard: [${{ env.BBG_REF }}](${{ env.BBG_URL }})
          
          -> SUSFS4KSU:
            -> gki-android15-6.6: [${{ env.COMMIT_HASH_gki_android15_6_6 }}](${{ env.COMMIT_URL_gki_android15_6_6 }})
          EOF

      - name: Set release body (No SUSFS)
        if: ${{ !inputs.enable_susfs }}
        run: |
          cat << EOF > release_body.md
      
          **‚ú® XENNET KERNELSU**
          **üåÄ XKNSU v${{ env.KSUVER }}**
          **üß¨ HymoFS Enabled**
          **üåê IPSet Support for Advanced Network Filtering**
          **üü¢ WireGuard Support**
          **üöÄ BBR v1 Support**
          **üîí BBG Protection to Prevent Unauthorized Writes to Certain Partitions**
        
          Commit Hashes (at the time of release):
          -> XENNET KERNELSU: [${{ env.WKSU_REF }}](${{ env.WKSU_URL }})

          -> Baseband-guard: [${{ env.BBG_REF }}](${{ env.BBG_URL }})
          
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.NEW_TAG }}
          prerelease: false
          files: ""
          name: ${{ env.RELEASE_NAME }}
          body_path: release_body.md

      - name: Upload Release Assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          for file in ./downloaded-artifacts/*/*; do
            if [ -d "$file" ]; then
              continue
            fi
            echo "Uploading $file..."
            gh release upload ${{ env.NEW_TAG }} "$file"
          done

          
      - name: Display Files Uploaded
        run: |
          echo "GitHub release created with the following files:"
          ls ./downloaded-artifacts/**/*
            
    
