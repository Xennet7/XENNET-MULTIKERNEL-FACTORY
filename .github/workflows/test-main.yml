name: GKI Kernel Factory Core Script
permissions:
  contents: write  # Allow writing to repository contents (for pushing tags)
  actions: write   # Allows triggering actions

on:
  workflow_call: # This allows this workflow to be called from another workflow
    inputs:
      make_release:
        required: true
        type: boolean
        default: true
      android_version:
        required: true
        type: string
      kernel_version:
        required: true
        type: string
      sub_level:
        required: true
        type: string
      os_patch_level:
        required: true
        type: string
      kernelsu_variant:
        required: true
        type: string
      kernelsu_branch:
        required: true
        type: string
      revision:
        required: false
        type: string
      kernelsu_commit:
        required: false
        type: string
      susfs_commit:
        required: false
        type: string
      version:
        required: false
        type: string
      use_zram:
        required: true
        type: boolean
        default: true
      use_bbg:
        required: true
        type: boolean
        default: true
      use_kpm:
        required: true
        type: boolean
        default: true
      supp_op:
        required: true
        type: boolean
        default: false
      onlyAk3:
        required: true
        type: boolean
        default: false
      build_time:
        required: false
        type: string

jobs:
  build-kernel-kernelsu-susfs:
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"

    steps:
      - name: Maximize Build Space
        uses: AdityaGarg8/remove-unwanted-software@v5
        with:
          remove-dotnet: 'true'          # Frees ~2 GB
          remove-android: 'true'         # Frees ~9 GB
          remove-haskell: 'true'         # Frees ~5.2 GB
          remove-codeql: 'true'          # Frees ~5.4 GB
          remove-docker-images: 'true'   # Frees ~3.2 GB
          remove-large-packages: 'true'  # Frees ~3.1 GB
          remove-swapfile: 'true'        # Frees ~4 GB
          remove-cached-tools: 'false'   # Avoid unless confirmed safe
          verbose: 'true'                # Enable detailed logging

      - name: Set CONFIG Environment Variable
        run: |
          # Set CONFIG dynamically based on inputs values
          CONFIG="${{ inputs.android_version }}-${{ inputs.kernel_version }}-${{ inputs.sub_level }}"
          # Set CONFIG as an environment variable for future steps
          echo "CONFIG=$CONFIG" >> $GITHUB_ENV


      
      

      - name: Get KSU Versions
        run: |
          set -euo pipefail

          KERNELSU_VARIANT="${{ inputs.kernelsu_variant }}"
          KERNELSU_COMMIT="${{ inputs.kernelsu_commit }}"   # may be empty

          echo "Resolving KSU repo for variant: $KERNELSU_VARIANT (commit: ${KERNELSU_COMMIT:-none})"

          if [ "$KERNELSU_VARIANT" = "Next" ]; then
            echo "This is the Next variant"
            git clone https://github.com/KernelSU-Next/KernelSU-Next.git Verfold
          elif [ "$KERNELSU_VARIANT" = "SukiSU" ]; then
            echo "This is the SukiSU variant"
            git clone https://github.com/SukiSU-Ultra/SukiSU-Ultra.git Verfold
          elif [ "$KERNELSU_VARIANT" = "Official" ]; then
            echo "This is the Official variant"
            git clone https://github.com/tiann/KernelSU.git Verfold
          elif [ "$KERNELSU_VARIANT" = "MKSU" ]; then
            echo "This is the MKSU variant"
            git clone https://github.com/5ec1cff/KernelSU.git Verfold
          else
            echo "Unknown variant: $KERNELSU_VARIANT"
            exit 1
          fi

          cd Verfold

          # If a specific commit SHA was provided, fetch it (in case of shallow clone) and checkout
          if [ -n "$KERNELSU_COMMIT" ]; then
            echo "User requested KernelSU commit: $KERNELSU_COMMIT — fetching and checking out"
            git fetch --depth=1 origin "$KERNELSU_COMMIT" || git fetch origin "$KERNELSU_COMMIT" || git fetch --unshallow origin || true
            git checkout --detach "$KERNELSU_COMMIT"
          else
            echo "No specific commit requested — using repo HEAD"
          fi

          # Calculating the KSU version number based on commit count
          KSU_GIT_VERSION=$(git rev-list --count HEAD)
          VAR=$([[ "$KERNELSU_VARIANT" == "SukiSU" ]] && echo 700 || echo 200)

          KSU_VERSION=$((10000 + KSU_GIT_VERSION + VAR))

          if [ "$KERNELSU_VARIANT" = "SukiSU" ]; then
            KSU_VERSION=$((40000 + KSU_GIT_VERSION - 2815))
          elif [ "$KERNELSU_VARIANT" = "Official" ] || [ "$KERNELSU_VARIANT" = "MKSU" ]; then
            KSU_VERSION=$((30000 + KSU_GIT_VERSION))
          fi

          echo "Determined KSU numeric version: $KSU_VERSION (commit: $(git rev-parse --short HEAD))"
          echo "KSUVER=$KSU_VERSION" >> $GITHUB_ENV

          # cleanup
          cd ..
          rm -rf Verfold

  